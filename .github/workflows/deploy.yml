name: Multi-Platform Parallel Deploy

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
  
permissions:
  contents: write
  deployments: write

jobs:
  # ==========================================
  # ä»»åŠ¡ 1: ç»Ÿä¸€æ„å»º (Single Build Source)
  # ==========================================
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Setup Node.js âš™ï¸
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install and Build ğŸ”§
        run: |
          npm ci
          npm run build

      - name: Prepare Platform Configs ğŸš€
        run: |
          cp dist/index.html dist/404.html
          
          # ç”Ÿæˆ Vercel é…ç½®
          cp vercel.json dist/ || echo '{"rewrites": [{"source": "/(.*)", "destination": "/index.html"}]}' > dist/vercel.json
          
          # ç”Ÿæˆ Cloudflare é…ç½®
          echo "/* /index.html 200" > dist/_redirects

      - name: Upload Build Artifact ğŸ“¦
        uses: actions/upload-artifact@v4
        with:
          name: site-dist
          path: dist/
          retention-days: 1

  # ==========================================
  # ä»»åŠ¡ 2: éƒ¨ç½²åˆ° GitHub Pages (gh.couuas.pp.ua)
  # ==========================================
  deploy-github:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact ğŸ“¥
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: dist/

      - name: Deploy to GitHub Pages ğŸš€
        uses: peaceiris/actions-gh-pages@v4
        with:
          deploy_key: ${{ secrets.ACCESS_TOKEN }}
          external_repository: couuas/couuas.github.io
          publish_branch: main
          publish_dir: ./dist
          commit_message: "Deploy: ${{ github.event.head_commit.message }}"
          force_orphan: true

  # ==========================================
  # ä»»åŠ¡ 3: éƒ¨ç½²åˆ° Cloudflare Pages (cf.couuas.pp.ua)
  # ==========================================
  deploy-cloudflare:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact ğŸ“¥
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: dist/

      - name: Deploy to Cloudflare Pages â˜ï¸
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: wasker-vue 
          directory: ./dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================
  # ä»»åŠ¡ 4: éƒ¨ç½²åˆ° Vercel (vc.couuas.pp.ua)
  # ==========================================
  deploy-vercel:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Download Artifact ğŸ“¥
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: dist/

      - name: Deploy to Vercel ğŸ“
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./
          vercel-project-name: wasker-vue 